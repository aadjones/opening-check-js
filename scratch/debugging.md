# Debugging Plan - June 2, 2025

## Implementing a Backend Proxy for CORS Issues

- [x] **Step 1: Install HTTPX**
  - Add `httpx` to your `requirements.txt` file.
  - Run `pip install -r requirements.txt` to install the package.

- [x] **Step 2: Add Proxy Endpoint**
  - Open `main.py` in the `chess_backend` directory.
  - Add a new endpoint `/proxy/{path:path}` that forwards requests to the Lichess API using `httpx`.

- [x] **Step 3: Configure CORS**
  - Ensure the CORS middleware in `main.py` allows requests from your frontend.
  - Update the `origins` list if necessary to include all frontend URLs.

- [x] **Step 4: Update Frontend**
  - Modify the frontend code to send requests to the new proxy endpoint instead of directly to the Lichess API.

- [x] **Step 5: Test the Proxy**
  - Run the backend server and test the proxy endpoint to ensure it forwards requests correctly.
  - Check for any errors or issues in the console and logs.

- [x] **Step 6: Debug and Refine**
  - Address any issues encountered during testing.
  - Refine the proxy implementation as needed to handle edge cases or improve performance.

- [x] **Step 7: Document Changes**
  - Update any relevant documentation to reflect the new proxy setup.
  - Ensure team members are informed of the changes and how to use the proxy.

# Debugging Plan for Deviation Detail Page

**Date:** June 5, 2025

## Goal
Fix logical and UI/UX issues on the Deviation Detail page so that:
- The correct move played and expected move are shown at the deviation point
- The chessboard displays the correct position at the deviation
- Move navigation controls work as expected
- The UI is visually clear and user-friendly

---

## Step 1: Logic & Data Flow Fixes (COMPLETE)

- [x] 1.1. PGN Parsing & Move History
- [x] 1.2. Deviation Index Calculation
- [x] 1.3. Move Comparison Display
- [x] 1.4. Chessboard Position
- [x] 1.5. Navigation Controls

---

## Step 2: UI/UX Improvements (IN PROGRESS)

- [ ] Redesign layout with clear cards/panels for each section
- [ ] Improve move comparison visuals (compact, clear, use icons/SAN)
- [ ] Polish chessboard and navigation controls (centered, tooltips, spacing)
- [ ] Group and style action buttons for clarity and compactness
- [ ] Ensure responsiveness and consistent styling throughout

---

## Next Actions
1. Continue with UI/UX redesign as described in Step 2, checking off each item as it is completed.
2. Test with real deviations and edge cases.
3. Polish and finalize the user experience.

# Production-Grade Deviations Endpoint Plan (June 6, 2025)

## Goal
Implement a secure, scalable, and production-ready endpoint for fetching user deviations with pagination, using authentication context (not user-supplied IDs).

---

## Strategy
- **Authentication:** Only allow access to deviations for the authenticated user. Do not accept user_id as a query parameter.
- **Endpoint:** `GET /api/deviations?limit=10&offset=0`
- **Pagination:** Support `limit` and `offset` query parameters for scalable data access.
- **Security:** Extract user identity from the session or JWT (auth.js + Lichess OAuth integration).
- **Data Model:** Return all fields needed by the frontend, matching the `ApiDeviationResult` model (including `game_id`).
- **Extensibility:** Allow for future filters (date, opening, etc.) as additional query parameters.

---

## Implementation Steps

1. **Backend: User Extraction**
   - Integrate FastAPI dependency or middleware to extract the authenticated user's UUID from the request/session/JWT.

2. **Backend: Supabase Query**
   - Add a function in `supabase_client.py` to fetch deviations for a user, supporting `limit` and `offset`.

3. **Backend: Endpoint**
   - Add a new endpoint in `main.py` (`GET /api/deviations`) that:
     - Uses the authenticated user's UUID.
     - Accepts `limit` and `offset` as query parameters.
     - Returns a list of deviations for that user.

4. **Frontend: Data Fetching**
   - Update the dashboard to call `/api/deviations?limit=10&offset=0` (no user_id param).
   - Support pagination ("Load More" or infinite scroll).

5. **Testing & Security Review**
   - Test with real user sessions.
   - Ensure no user can access another user's deviations.
   - Review for edge cases and error handling.

---

## Next Actions
- [ ] Step 1: Backend user extraction from auth context
- [ ] Step 2: Supabase paginated query for deviations
- [ ] Step 3: FastAPI endpoint for paginated deviations
- [ ] Step 4: Frontend integration and pagination
- [ ] Step 5: Testing and security review

# Supabase Types Cleanup Checklist (June 2025)

## Goal
Refactor the codebase to use the autogenerated Supabase types everywhere possible, ensuring type safety and reducing redundancy.

## Steps
1. **Identify Custom Types to Replace**
   - [ ] Search for all custom interfaces/types that represent Supabase tables (e.g., `ApiDeviationResult`, `Profile`, etc.) in `src/types/index.ts` and elsewhere.
   - [ ] Make a list of all such types.

2. **Update Imports and Usages**
   - [ ] In all files that use these custom types, import the corresponding type from `src/types/supabase.ts` instead.
   - [ ] Example: `type Deviation = Database['public']['Tables']['opening_deviations']['Row'];`

3. **Update Hooks and API Calls**
   - [ ] Update hooks (e.g., `useDeviations`) and API call results to use the generated types.
   - [ ] Ensure all Supabase query results are typed with the generated types.

4. **Update Components**
   - [ ] Update component props and state types (e.g., in `GamesList`, `Dashboard`, etc.) to use the generated types.

5. **Remove Redundant Custom Types**
   - [ ] Once all usages are updated, delete the old custom interfaces from `src/types/index.ts` and elsewhere.

6. **Test Thoroughly**
   - [ ] Run the app and all tests to ensure everything works and is type-safe.
   - [ ] Fix any type errors or runtime issues that arise.

7. **Document the Workflow**
   - [ ] Add a note to the README or docs: After any DB schema change, regenerate types with:
     ```sh
     supabase gen types typescript --project-id fsmtmtconmgujlhmkqgp > src/types/supabase.ts
     ```
   - [ ] Remind contributors to always use the generated types for Supabase data.

---

**Next Actions:**
- [ ] Start with step 1: inventory all custom types to replace. 